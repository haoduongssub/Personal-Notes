<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thanh to√°n - OTO VI·ªÜT</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../styles.css">

</head>

<body>
    <header class="header">
        <div class="container header-content">
            <a href="/" class="logo">
                <div class="logo-icon">üöó</div><span>OTO VI·ªÜT</span>
            </a>
            <div class="header-actions">
                <a href="cart.html" class="btn btn-ghost btn-sm">‚Üê Quay l·∫°i gi·ªè h√†ng</a>
            </div>
        </div>
    </header>

    <section class="checkout-page">
        <div class="container">
            <h1 class="mb-xl">Thanh to√°n</h1>
            <div id="checkoutContent">
                <div class="checkout-layout">
                    <div>
                        <div class="checkout-form">
                            <h2 class="checkout-title">Th√¥ng tin giao h√†ng</h2>
                            <div id="alertMessage" class="alert d-none"></div>
                            <form id="checkoutForm">
                                <div class="form-group">
                                    <label class="form-label">H·ªç v√† t√™n *</label>
                                    <input type="text" id="fullName" class="form-input" placeholder="Nh·∫≠p h·ªç v√† t√™n"
                                        required autocomplete="name">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">S·ªë ƒëi·ªán tho·∫°i *</label>
                                    <input type="tel" id="phone" class="form-input" placeholder="Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i"
                                        required autocomplete="tel">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">ƒê·ªãa ch·ªâ giao h√†ng *</label>
                                    <textarea id="address" class="form-textarea" placeholder="Nh·∫≠p ƒë·ªãa ch·ªâ chi ti·∫øt"
                                        required autocomplete="street-address"></textarea>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Ghi ch√∫</label>
                                    <textarea id="note" class="form-textarea"
                                        placeholder="Ghi ch√∫ th√™m (kh√¥ng b·∫Øt bu·ªôc)"></textarea>
                                </div>
                            </form>
                        </div>

                        <div class="checkout-form mt-lg">
                            <h2 class="checkout-title">Ph∆∞∆°ng th·ª©c thanh to√°n</h2>
                            <div class="payment-options">
                                <label class="payment-option selected" onclick="selectPayment(this, 'cash')">
                                    <input type="radio" name="payment" value="cash" checked>
                                    <span class="radio"></span>
                                    <div>
                                        <strong>üíµ Thanh to√°n khi nh·∫≠n h√†ng (COD)</strong>
                                        <p class="payment-description">Thanh to√°n
                                            b·∫±ng ti·ªÅn m·∫∑t khi nh·∫≠n xe</p>
                                    </div>
                                </label>
                                <label class="payment-option" onclick="selectPayment(this, 'bank')">
                                    <input type="radio" name="payment" value="bank">
                                    <span class="radio"></span>
                                    <div>
                                        <strong>üè¶ Chuy·ªÉn kho·∫£n ng√¢n h√†ng</strong>
                                        <p class="payment-description">Chuy·ªÉn
                                            kho·∫£n tr∆∞·ªõc khi giao xe</p>
                                    </div>
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="cart-summary">
                        <div class="summary-card">
                            <h3 class="summary-title">ƒê∆°n h√†ng c·ªßa b·∫°n</h3>
                            <div class="order-items-preview" id="orderItemsPreview"></div>
                            <div class="summary-row mt-lg">
                                <span>T·∫°m t√≠nh</span>
                                <span id="subtotal">0ƒë</span>
                            </div>
                            <div class="summary-row">
                                <span>Ph√≠ v·∫≠n chuy·ªÉn</span>
                                <span>Mi·ªÖn ph√≠</span>
                            </div>
                            <div class="summary-row total">
                                <span>T·ªïng c·ªông</span>
                                <span class="summary-value" id="total">0ƒë</span>
                            </div>
                            <button type="button" class="btn btn-primary w-full btn-lg mt-lg" id="submitOrderBtn"
                                onclick="submitOrder()">
                                ƒê·∫∑t h√†ng
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="../js/config.js"></script>
    <script src="../js/firebase-config.js"></script>
    <script src="../js/auth.js"></script>
    <script src="../js/app.js"></script>
    <script src="../js/cart.js"></script>
    <script src="../js/orders.js"></script>
    <script>
        let selectedPayment = 'cash';

        function selectPayment(el, method) {
            document.querySelectorAll('.payment-option').forEach(opt => opt.classList.remove('selected'));
            el.classList.add('selected');
            selectedPayment = method;
        }

        function renderCheckout() {
            const items = Cart.getItems();
            if (items.length === 0) { window.location.href = 'cart.html'; return; }

            const preview = document.getElementById('orderItemsPreview');
            preview.innerHTML = items.map(item =>
                '<div class="order-item-mini"><img src="' + item.image + '" alt=""><div class="order-item-mini-info"><div class="order-item-mini-name">' + item.name + '</div><div class="order-item-mini-price">' + App.formatPriceFull(item.price) + ' x' + item.quantity + '</div></div></div>'
            ).join('');

            document.getElementById('subtotal').textContent = App.formatPriceFull(Cart.getTotalPrice());
            document.getElementById('total').textContent = App.formatPriceFull(Cart.getTotalPrice());
        }

        async function submitOrder() {
            const alertEl = document.getElementById('alertMessage');
            const btn = document.getElementById('submitOrderBtn');

            if (!Auth.isLoggedIn()) {
                alertEl.className = 'alert alert-warning';
                alertEl.innerHTML = '‚ö†Ô∏è Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ ƒë·∫∑t h√†ng';
                alertEl.style.display = 'flex';
                setTimeout(() => { window.location.href = 'login.html'; }, 1500);
                return;
            }

            const fullName = document.getElementById('fullName').value.trim();
            const phone = document.getElementById('phone').value.trim();
            const address = document.getElementById('address').value.trim();
            const note = document.getElementById('note').value.trim();

            if (!fullName || !phone || !address) {
                alertEl.className = 'alert alert-error';
                alertEl.innerHTML = '‚úï Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin b·∫Øt bu·ªôc';
                alertEl.style.display = 'flex';
                return;
            }

            btn.disabled = true;
            btn.textContent = 'ƒêang x·ª≠ l√Ω...';

            const result = await Orders.createOrder({ fullName, phone, address, note }, selectedPayment);

            if (result.success) {
                alertEl.className = 'alert alert-success';
                alertEl.innerHTML = '‚úì ƒê·∫∑t h√†ng th√†nh c√¥ng! M√£ ƒë∆°n: ' + result.orderId.slice(-8).toUpperCase();
                alertEl.style.display = 'flex';
                setTimeout(() => { window.location.href = 'profile.html'; }, 2000);
            } else {
                alertEl.className = 'alert alert-error';
                alertEl.innerHTML = '‚úï ' + result.error;
                alertEl.style.display = 'flex';
                btn.disabled = false;
                btn.textContent = 'ƒê·∫∑t h√†ng';
            }
        }

        document.addEventListener('DOMContentLoaded', renderCheckout);
    </script>
</body>

</html>