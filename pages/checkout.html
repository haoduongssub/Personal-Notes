<!DOCTYPE html>
<html lang="vi">
<!--
================================================================================
OTO VI·ªÜT - TRANG THANH TO√ÅN (checkout.html)
================================================================================

Trang n√†y cho ph√©p ng∆∞·ªùi d√πng ho√†n t·∫•t ƒë∆°n h√†ng.

CH·ª®C NƒÇNG:
- Hi·ªÉn th·ªã t√≥m t·∫Øt ƒë∆°n h√†ng (t·ª´ gi·ªè h√†ng)
- Form nh·∫≠p th√¥ng tin giao h√†ng (h·ªç t√™n, SƒêT, ƒë·ªãa ch·ªâ)
- Ch·ªçn ph∆∞∆°ng th·ª©c thanh to√°n (COD ho·∫∑c chuy·ªÉn kho·∫£n)
- G·ªçi Orders.createOrder() ƒë·ªÉ l∆∞u ƒë∆°n h√†ng v√†o Firestore
- Redirect ƒë·∫øn profile sau khi ƒë·∫∑t h√†ng th√†nh c√¥ng

Y√äU C·∫¶U:
- Ph·∫£i ƒëƒÉng nh·∫≠p m·ªõi ƒë∆∞·ª£c ƒë·∫∑t h√†ng
- Gi·ªè h√†ng ph·∫£i c√≥ √≠t nh·∫•t 1 s·∫£n ph·∫©m

================================================================================
-->

<head>
    <!-- ===== META TAGS ===== -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thanh to√°n - OTO VI·ªÜT</title>

    <!-- ===== GOOGLE FONTS ===== -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <!-- ===== CSS ===== -->
    <link rel="stylesheet" href="../styles.css">
</head>

<body>
    <!-- ================================================================
         PH·∫¶N 1: HEADER
         ================================================================ -->
    <header class="header" id="header">
        <div class="container header-content">

            <!-- Logo -->
            <a href="/" class="logo">
                <div class="logo-icon">üöó</div><span>OTO VI·ªÜT</span>
            </a>

            <!-- Navigation -->
            <nav class="nav">
                <a href="/" class="nav-link">Trang ch·ªß</a>
                <a href="cart.html" class="nav-link">Gi·ªè h√†ng</a>
            </nav>

            <!-- Header Actions -->
            <div class="header-actions">
                <a href="cart.html" class="cart-btn">üõí<span class="cart-count d-none" id="cartCount">0</span></a>
            </div>
        </div>
    </header>

    <!-- ================================================================
         PH·∫¶N 2: N·ªòI DUNG TRANG THANH TO√ÅN
         ================================================================ -->
    <section class="checkout-page">
        <div class="container">

            <!-- Ti√™u ƒë·ªÅ -->
            <h1 class="page-title">Thanh to√°n</h1>

            <!-- ===== ALERT MESSAGE ===== -->
            <div id="alertMessage" class="alert d-none"></div>

            <!-- ===== LAYOUT CH√çNH: 2 C·ªòT ===== -->
            <div class="checkout-layout">

                <!-- ================================================
                     C·ªòT TR√ÅI: FORM TH√îNG TIN GIAO H√ÄNG
                     ================================================ -->
                <div class="checkout-form">
                    <div class="form-section">
                        <h2 class="section-title">Th√¥ng tin giao h√†ng</h2>

                        <!-- H·ªç v√† t√™n -->
                        <div class="form-group">
                            <label for="fullName" class="form-label">H·ªç v√† t√™n *</label>
                            <input type="text" id="fullName" class="form-input" placeholder="Nh·∫≠p h·ªç v√† t√™n ng∆∞·ªùi nh·∫≠n"
                                required>
                        </div>

                        <!-- S·ªë ƒëi·ªán tho·∫°i -->
                        <div class="form-group">
                            <label for="phone" class="form-label">S·ªë ƒëi·ªán tho·∫°i *</label>
                            <input type="tel" id="phone" class="form-input" placeholder="Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i" required>
                        </div>

                        <!-- ƒê·ªãa ch·ªâ -->
                        <div class="form-group">
                            <label for="address" class="form-label">ƒê·ªãa ch·ªâ giao h√†ng *</label>
                            <textarea id="address" class="form-input form-textarea" placeholder="Nh·∫≠p ƒë·ªãa ch·ªâ chi ti·∫øt"
                                required></textarea>
                        </div>

                        <!-- Ghi ch√∫ -->
                        <div class="form-group">
                            <label for="note" class="form-label">Ghi ch√∫</label>
                            <textarea id="note" class="form-input form-textarea"
                                placeholder="Ghi ch√∫ th√™m (n·∫øu c√≥)"></textarea>
                        </div>
                    </div>

                    <!-- ===== CH·ªåN PH∆Ø∆†NG TH·ª®C THANH TO√ÅN ===== -->
                    <div class="form-section">
                        <h2 class="section-title">Ph∆∞∆°ng th·ª©c thanh to√°n</h2>

                        <!-- Option 1: Thanh to√°n khi nh·∫≠n xe (COD) -->
                        <div class="payment-options">
                            <label class="payment-option active" id="cashOption">
                                <input type="radio" name="payment" value="cash" checked>
                                <div class="payment-content">
                                    <span class="payment-icon">üíµ</span>
                                    <div>
                                        <span class="payment-title">Thanh to√°n khi nh·∫≠n xe</span>
                                        <span class="payment-desc">Thanh to√°n tr·ª±c ti·∫øp khi nh·∫≠n xe</span>
                                    </div>
                                </div>
                            </label>

                            <!-- Option 2: Chuy·ªÉn kho·∫£n ng√¢n h√†ng -->
                            <label class="payment-option" id="bankOption">
                                <input type="radio" name="payment" value="bank">
                                <div class="payment-content">
                                    <span class="payment-icon">üè¶</span>
                                    <div>
                                        <span class="payment-title">Chuy·ªÉn kho·∫£n ng√¢n h√†ng</span>
                                        <span class="payment-desc">Chuy·ªÉn kho·∫£n tr∆∞·ªõc khi nh·∫≠n xe</span>
                                    </div>
                                </div>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- ================================================
                     C·ªòT PH·∫¢I: T√ìM T·∫ÆT ƒê∆†N H√ÄNG
                     ================================================ -->
                <div class="checkout-summary">
                    <div class="summary-card">
                        <h3 class="summary-title">ƒê∆°n h√†ng c·ªßa b·∫°n</h3>

                        <!-- Danh s√°ch s·∫£n ph·∫©m (render b·∫±ng JS) -->
                        <div class="summary-items" id="orderItems">
                            <!-- M·ªói s·∫£n ph·∫©m ƒë∆∞·ª£c render th√†nh:
                            <div class="summary-item">
                                <img src="..." class="summary-item-image">
                                <div class="summary-item-info">
                                    <span class="summary-item-name">T√™n xe</span>
                                    <span class="summary-item-qty">x1</span>
                                </div>
                                <span class="summary-item-price">1.000.000ƒë</span>
                            </div>
                            -->
                        </div>

                        <div class="summary-divider"></div>

                        <!-- T·∫°m t√≠nh -->
                        <div class="summary-row">
                            <span>T·∫°m t√≠nh</span>
                            <span id="subtotal">0ƒë</span>
                        </div>

                        <!-- Ph√≠ v·∫≠n chuy·ªÉn -->
                        <div class="summary-row">
                            <span>Ph√≠ v·∫≠n chuy·ªÉn</span>
                            <span class="text-success">Mi·ªÖn ph√≠</span>
                        </div>

                        <div class="summary-divider"></div>

                        <!-- T·ªïng c·ªông -->
                        <div class="summary-row total">
                            <span>T·ªïng c·ªông</span>
                            <span class="summary-value" id="total">0ƒë</span>
                        </div>

                        <!-- N√∫t ƒë·∫∑t h√†ng -->
                        <button id="submitOrderBtn" class="btn btn-primary w-full btn-lg mt-lg" onclick="submitOrder()">
                            ƒê·∫∑t h√†ng
                        </button>

                        <!-- Link quay l·∫°i gi·ªè h√†ng -->
                        <a href="cart.html" class="btn btn-ghost w-full mt-sm">
                            Quay l·∫°i gi·ªè h√†ng
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- ================================================================
         PH·∫¶N 3: SCRIPTS
         ================================================================ -->

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <!-- App Scripts -->
    <script src="../js/config.js"></script>
    <script src="../js/firebase-config.js"></script>
    <script src="../js/auth.js"></script>
    <script src="../js/app.js"></script>
    <script src="../js/cart.js"></script>
    <script src="../js/orders.js"></script>

    <script>
        /* ================================================================
           SCRIPT: X·ª¨ L√ù TRANG THANH TO√ÅN
           ================================================================ */

        /* ----------------------------------------
           BI·∫æN L∆ØU PH∆Ø∆†NG TH·ª®C THANH TO√ÅN ƒê∆Ø·ª¢C CH·ªåN
           ---------------------------------------- */
        let selectedPayment = 'cash';  // M·∫∑c ƒë·ªãnh: thanh to√°n khi nh·∫≠n xe

        /* ----------------------------------------
           RENDER T√ìM T·∫ÆT ƒê∆†N H√ÄNG
           ----------------------------------------
           Hi·ªÉn th·ªã danh s√°ch s·∫£n ph·∫©m v√† t·ªïng ti·ªÅn
           ---------------------------------------- */
        function renderOrderSummary() {
            const items = Cart.getItems();
            const orderItemsEl = document.getElementById('orderItems');
            const subtotalEl = document.getElementById('subtotal');
            const totalEl = document.getElementById('total');

            // Ki·ªÉm tra gi·ªè h√†ng tr·ªëng
            if (items.length === 0) {
                // Redirect v·ªÅ gi·ªè h√†ng n·∫øu tr·ªëng
                window.location.href = 'cart.html';
                return;
            }

            // Render danh s√°ch s·∫£n ph·∫©m
            orderItemsEl.innerHTML = items.map(item => `
                <div class="summary-item">
                    <img src="${item.image}" alt="${item.name}" class="summary-item-image">
                    <div class="summary-item-info">
                        <span class="summary-item-name">${item.name}</span>
                        <span class="summary-item-qty">x${item.quantity}</span>
                    </div>
                    <span class="summary-item-price">${App.formatPriceFull(item.price * item.quantity)}</span>
                </div>
            `).join('');

            // T√≠nh v√† hi·ªÉn th·ªã t·ªïng ti·ªÅn
            const total = Cart.getTotalPrice();
            subtotalEl.textContent = App.formatPriceFull(total);
            totalEl.textContent = App.formatPriceFull(total);
        }

        /* ----------------------------------------
           X·ª¨ L√ù CH·ªåN PH∆Ø∆†NG TH·ª®C THANH TO√ÅN
           ---------------------------------------- */
        function setupPaymentOptions() {
            const paymentOptions = document.querySelectorAll('.payment-option');

            paymentOptions.forEach(option => {
                option.addEventListener('click', () => {
                    // B·ªè class active kh·ªèi t·∫•t c·∫£ options
                    paymentOptions.forEach(o => o.classList.remove('active'));

                    // Th√™m class active v√†o option ƒë∆∞·ª£c ch·ªçn
                    option.classList.add('active');

                    // L∆∞u gi√° tr·ªã ph∆∞∆°ng th·ª©c thanh to√°n
                    selectedPayment = option.querySelector('input').value;
                });
            });
        }

        /* ----------------------------------------
           X·ª¨ L√ù ƒê·∫∂T H√ÄNG
           ----------------------------------------
           ƒê∆∞·ª£c g·ªçi khi click n√∫t "ƒê·∫∑t h√†ng"
           ---------------------------------------- */
        async function submitOrder() {
            const alertEl = document.getElementById('alertMessage');
            const btn = document.getElementById('submitOrderBtn');

            // ===== KI·ªÇM TRA ƒêƒÇNG NH·∫¨P =====
            if (!Auth.isLoggedIn()) {
                alertEl.className = 'alert alert-warning';
                alertEl.innerHTML = '‚ö†Ô∏è Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ ƒë·∫∑t h√†ng';
                alertEl.style.display = 'flex';

                // Redirect ƒë·∫øn trang login sau 1.5 gi√¢y
                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 1500);
                return;
            }

            // ===== L·∫§Y TH√îNG TIN T·ª™ FORM =====
            const fullName = document.getElementById('fullName').value.trim();
            const phone = document.getElementById('phone').value.trim();
            const address = document.getElementById('address').value.trim();
            const note = document.getElementById('note').value.trim();

            // ===== VALIDATION =====
            if (!fullName || !phone || !address) {
                alertEl.className = 'alert alert-error';
                alertEl.innerHTML = '‚úï Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin b·∫Øt bu·ªôc';
                alertEl.style.display = 'flex';
                return;
            }

            // ===== DISABLE N√öT V√Ä HI·ªÇN TH·ªä LOADING =====
            btn.disabled = true;
            btn.textContent = 'ƒêang x·ª≠ l√Ω...';

            // ===== G·ªåI API T·∫†O ƒê∆†N H√ÄNG =====
            const result = await Orders.createOrder(
                { fullName, phone, address, note },  // Th√¥ng tin kh√°ch h√†ng
                selectedPayment                       // Ph∆∞∆°ng th·ª©c thanh to√°n
            );

            if (result.success) {
                // ===== ƒê·∫∂T H√ÄNG TH√ÄNH C√îNG =====
                alertEl.className = 'alert alert-success';
                alertEl.innerHTML = '‚úì ƒê·∫∑t h√†ng th√†nh c√¥ng! M√£ ƒë∆°n: ' + result.orderId.slice(-8).toUpperCase();
                alertEl.style.display = 'flex';

                // Redirect ƒë·∫øn trang profile sau 2 gi√¢y
                setTimeout(() => {
                    window.location.href = 'profile.html';
                }, 2000);
            } else {
                // ===== ƒê·∫∂T H√ÄNG TH·∫§T B·∫†I =====
                alertEl.className = 'alert alert-error';
                alertEl.innerHTML = '‚úï ' + result.error;
                alertEl.style.display = 'flex';

                // Enable l·∫°i n√∫t
                btn.disabled = false;
                btn.textContent = 'ƒê·∫∑t h√†ng';
            }
        }

        /* ----------------------------------------
           KH·ªûI T·∫†O TRANG
           ---------------------------------------- */
        document.addEventListener('DOMContentLoaded', () => {
            renderOrderSummary();    // Render t√≥m t·∫Øt ƒë∆°n h√†ng
            setupPaymentOptions();   // G·∫Øn s·ª± ki·ªán cho payment options
        });
    </script>
</body>

</html>